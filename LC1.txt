import os
import warnings
from dotenv import load_dotenv
from typing import Annotated, TypedDict
from langchain_google_genai import ChatGoogleGenerativeAI
from langgraph.graph import StateGraph, START, END
from langgraph.graph.message import add_messages

# 1. Silence the Pydantic warnings so we can see clearly
warnings.filterwarnings("ignore", category=UserWarning)

# 2. Open the Secret Vault
load_dotenv()

# 3. SAFETY CHECK: Let's make sure the key is actually there
if not os.getenv("GOOGLE_API_KEY"):
    print("❌ ERROR: Key not found! Please make sure your file is named .env")
else:
    print("✅ Key found! The Brain is waking up...")

# 4. Define the Whiteboard (State)
class State(TypedDict):
    messages: Annotated[list, add_messages]

# 5. Create the Brain (LLM)
llm = ChatGoogleGenerativeAI(model="gemini-2.0-flash")

# 6. Create the Worker Node
def chatbot_node(state: State):
    # This sends the whiteboard history to the AI
    response = llm.invoke(state["messages"])
    return {"messages": [response]}

# 7. Build the Graph
workflow = StateGraph(State)
workflow.add_node("chatbot", chatbot_node)
workflow.add_edge(START, "chatbot")
workflow.add_edge("chatbot", END)

# 8. Compile
app = workflow.compile()

# 9. Run the Agent
print("Starting the agent...")
user_question = {"messages": [("user", "Hello! I am learning to build AI agents. Can you tell me one encouraging fact about AI?")]}
result = app.invoke(user_question)

print("\nAI Response:")
print(result["messages"][-1].content)